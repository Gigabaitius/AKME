// src/utils/Logger.js
/**
 * üìù –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è HR Assistant
 * @description –õ–æ–≥–≥–µ—Ä —Å —É—Ä–æ–≤–Ω—è–º–∏, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
 */
class Logger {
  constructor(context = 'App') {
    this.context = context;
    this.logs = [];
    this.maxLogs = 1000;
    this.logLevel = this.getLogLevel();
    this.enabledCategories = this.getEnabledCategories();
    
    // –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    this.levels = {
      ERROR: 0,
      WARN: 1,
      INFO: 2,
      DEBUG: 3,
      TRACE: 4
    };

    // –¶–≤–µ—Ç–∞ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏
    this.colors = {
      ERROR: '#ef4444',
      WARN: '#f59e0b',
      INFO: '#3b82f6',
      DEBUG: '#8b5cf6',
      TRACE: '#6b7280'
    };
  }

  /**
   * –ü–æ–ª—É—á–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
   */
  getLogLevel() {
    const level = import.meta.env.VITE_LOG_LEVEL || 'INFO';
    return this.levels[level.toUpperCase()] ?? this.levels.INFO;
  }

  /**
   * –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
   */
  getEnabledCategories() {
    const categories = import.meta.env.VITE_LOG_CATEGORIES;
    return categories ? categories.split(',') : ['*'];
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∫–∞, –≤–∫–ª—é—á–µ–Ω–∞ –ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è
   */
  isCategoryEnabled() {
    return this.enabledCategories.includes('*') || 
           this.enabledCategories.includes(this.context);
  }

  /**
   * –ë–∞–∑–æ–≤–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
   * @param {string} level - –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∞
   * @param {string} message - –°–æ–æ–±—â–µ–Ω–∏–µ
   * @param {any} data - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
   */
  log(level, message, data = null) {
    const levelNum = this.levels[level];
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Ä–æ–≤–µ–Ω—å –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é
    if (levelNum > this.logLevel || !this.isCategoryEnabled()) {
      return;
    }

    const timestamp = new Date().toISOString();
    const logEntry = {
      id: Date.now() + Math.random(),
      timestamp,
      level,
      context: this.context,
      message,
      data,
      url: window.location.href,
      userAgent: navigator.userAgent
    };

    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤ –ª–æ–≥–æ–≤
    this.logs.push(logEntry);
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –º–∞—Å—Å–∏–≤–∞
    if (this.logs.length > this.maxLogs) {
      this.logs.shift();
    }

    // –í—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å
    if (import.meta.env.VITE_ENABLE_CONSOLE_LOGS !== 'false') {
      this.outputToConsole(logEntry);
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
    this.saveToStorage(logEntry);

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –≤–Ω–µ—à–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
    this.sendToExternalSystems(logEntry);
  }

  /**
   * –í—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å
   * @param {Object} logEntry - –ó–∞–ø–∏—Å—å –ª–æ–≥–∞
   */
  outputToConsole(logEntry) {
    const { timestamp, level, context, message, data } = logEntry;
    const time = new Date(timestamp).toLocaleTimeString('ru-RU');
    const color = this.colors[level];
    
    const consoleMessage = `%c[${time}] [${level}] [${context}] ${message}`;
    const consoleStyle = `color: ${color}; font-weight: bold;`;
    
    switch (level) {
      case 'ERROR':
        console.error(consoleMessage, consoleStyle, data);
        break;
      case 'WARN':
        console.warn(consoleMessage, consoleStyle, data);
        break;
      case 'DEBUG':
        console.debug(consoleMessage, consoleStyle, data);
        break;
      case 'TRACE':
        console.trace(consoleMessage, consoleStyle, data);
        break;
      default:
        console.log(consoleMessage, consoleStyle, data);
    }
  }

  /**
   * –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
   * @param {Object} logEntry - –ó–∞–ø–∏—Å—å –ª–æ–≥–∞
   */
  saveToStorage(logEntry) {
    try {
      const storageKey = 'hr-assistant-logs';
      const stored = localStorage.getItem(storageKey) || '[]';
      const logs = JSON.parse(stored);
      
      logs.push(logEntry);
      
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–≥–æ–≤ –≤ storage
      if (logs.length > 500) {
        logs.splice(0, logs.length - 500);
      }
      
      localStorage.setItem(storageKey, JSON.stringify(logs));
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–∞ –≤ localStorage:', error);
    }
  }

  /**
   * –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –≤–Ω–µ—à–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
   * @param {Object} logEntry - –ó–∞–ø–∏—Å—å –ª–æ–≥–∞
   */
  sendToExternalSystems(logEntry) {
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Sentry (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
    if (window.Sentry && logEntry.level === 'ERROR') {
      window.Sentry.captureException(new Error(logEntry.message), {
        extra: logEntry.data,
        tags: {
          context: logEntry.context
        }
      });
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Google Analytics (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
    if (window.gtag && logEntry.level === 'ERROR') {
      window.gtag('event', 'exception', {
        description: logEntry.message,
        fatal: false,
        custom_map: {
          context: logEntry.context
        }
      });
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    if (logEntry.level === 'ERROR' && import.meta.env.VITE_ERROR_REPORTING_URL) {
      fetch(import.meta.env.VITE_ERROR_REPORTING_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(logEntry)
      }).catch(() => {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–æ–≤
      });
    }
  }

  /**
   * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
   * @param {string} message - –°–æ–æ–±—â–µ–Ω–∏–µ
   * @param {any} data - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
   */
  error(message, data = null) {
    this.log('ERROR', message, data);
  }

  /**
   * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
   * @param {string} message - –°–æ–æ–±—â–µ–Ω–∏–µ
   * @param {any} data - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
   */
  warn(message, data = null) {
    this.log('WARN', message, data);
  }

  /**
   * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
   * @param {string} message - –°–æ–æ–±—â–µ–Ω–∏–µ
   * @param {any} data - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
   */
  info(message, data = null) {
    this.log('INFO', message, data);
  }

  /**
   * –û—Ç–ª–∞–¥–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
   * @param {string} message - –°–æ–æ–±—â–µ–Ω–∏–µ
   * @param {any} data - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
   */
  debug(message, data = null) {
    this.log('DEBUG', message, data);
  }

  /**
   * –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞
   * @param {string} message - –°–æ–æ–±—â–µ–Ω–∏–µ
   * @param {any} data - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
   */
  trace(message, data = null) {
    this.log('TRACE', message, data);
  }

  /**
   * –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
   * @param {string} groupName - –ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã
   * @param {Function} callback - –§—É–Ω–∫—Ü–∏—è —Å –ª–æ–≥–∞–º–∏
   */
  group(groupName, callback) {
    if (import.meta.env.VITE_ENABLE_CONSOLE_LOGS !== 'false') {
      console.group(`üìÅ ${groupName}`);
    }
    
    try {
      callback();
    } finally {
      if (import.meta.env.VITE_ENABLE_CONSOLE_LOGS !== 'false') {
        console.groupEnd();
      }
    }
  }

  /**
   * –ò–∑–º–µ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
   * @param {string} label - –ú–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
   * @param {Function} callback - –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è
   */
  async time(label, callback) {
    const startTime = performance.now();
    const timerId = `${this.context}-${label}`;
    
    if (import.meta.env.VITE_ENABLE_CONSOLE_LOGS !== 'false') {
      console.time(timerId);
    }
    
    try {
      const result = await callback();
      const endTime = performance.now();
      const duration = endTime - startTime;
      
      this.debug(`‚è±Ô∏è ${label} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞ ${duration.toFixed(2)}ms`);
      
      if (import.meta.env.VITE_ENABLE_CONSOLE_LOGS !== 'false') {
        console.timeEnd(timerId);
      }
      
      return result;
    } catch (error) {
      const endTime = performance.now();
      const duration = endTime - startTime;
      
      this.error(`‚è±Ô∏è ${label} –æ—à–∏–±–∫–∞ –ø–æ—Å–ª–µ ${duration.toFixed(2)}ms`, error);
      
      if (import.meta.env.VITE_ENABLE_CONSOLE_LOGS !== 'false') {
        console.timeEnd(timerId);
      }
      
      throw error;
    }
  }

  /**
   * –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –ª–æ–≥–æ–≤
   * @param {Object} filters - –§–∏–ª—å—Ç—Ä—ã
   * @returns {Array} –ú–∞—Å—Å–∏–≤ –ª–æ–≥–æ–≤
   */
  getLogs(filters = {}) {
    let logs = [...this.logs];

    if (filters.level) {
      logs = logs.filter(log => log.level === filters.level);
    }

    if (filters.context) {
      logs = logs.filter(log => log.context === filters.context);
    }

    if (filters.since) {
      const since = new Date(filters.since);
      logs = logs.filter(log => new Date(log.timestamp) >= since);
    }

    if (filters.until) {
      const until = new Date(filters.until);
      logs = logs.filter(log => new Date(log.timestamp) <= until);
    }

    return logs;
  }

  /**
   * –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
   * @param {Date} cutoffDate - –î–∞—Ç–∞ –æ—Ç—Å–µ—á–∫–∏
   */
  cleanup(cutoffDate) {
    if (cutoffDate) {
      this.logs = this.logs.filter(log => new Date(log.timestamp) > cutoffDate);
    } else {
      this.logs = [];
    }

    // –û—á–∏—â–∞–µ–º localStorage
    try {
      const storageKey = 'hr-assistant-logs';
      if (cutoffDate) {
        const stored = localStorage.getItem(storageKey) || '[]';
        const logs = JSON.parse(stored);
        const filtered = logs.filter(log => new Date(log.timestamp) > cutoffDate);
        localStorage.setItem(storageKey, JSON.stringify(filtered));
      } else {
        localStorage.removeItem(storageKey);
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤ –≤ localStorage:', error);
    }
  }

  /**
   * –≠–∫—Å–ø–æ—Ä—Ç –ª–æ–≥–æ–≤
   * @param {string} format - –§–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞ (json, csv, txt)
   * @param {Object} filters - –§–∏–ª—å—Ç—Ä—ã
   * @returns {string} –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏
   */
  export(format = 'json', filters = {}) {
    const logs = this.getLogs(filters);

    switch (format.toLowerCase()) {
      case 'csv':
        const headers = ['Timestamp', 'Level', 'Context', 'Message', 'Data'];
        const rows = logs.map(log => [
          log.timestamp,
          log.level,
          log.context,
          log.message,
          JSON.stringify(log.data)
        ]);
        return [headers, ...rows].map(row => 
          row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
        ).join('\n');

      case 'txt':
        return logs.map(log => {
          const data = log.data ? ` | Data: ${JSON.stringify(log.data)}` : '';
          return `${log.timestamp} [${log.level}] [${log.context}] ${log.message}${data}`;
        }).join('\n');

      case 'json':
      default:
        return JSON.stringify(logs, null, 2);
    }
  }

  /**
   * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ª–æ–≥–æ–≤
   * @returns {Object} –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
   */
  getStats() {
    const stats = {
      total: this.logs.length,
      byLevel: {},
      byContext: {},
      recent: {
        lastHour: 0,
        lastDay: 0
      }
    };

    const now = new Date();
    const hourAgo = new Date(now.getTime() - 60 * 60 * 1000);
    const dayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);

    this.logs.forEach(log => {
      // –ü–æ —É—Ä–æ–≤–Ω—è–º
      stats.byLevel[log.level] = (stats.byLevel[log.level] || 0) + 1;
      
      // –ü–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
      stats.byContext[log.context] = (stats.byContext[log.context] || 0) + 1;
      
      // –ù–µ–¥–∞–≤–Ω–∏–µ
      const logTime = new Date(log.timestamp);
      if (logTime >= hourAgo) stats.recent.lastHour++;
      if (logTime >= dayAgo) stats.recent.lastDay++;
    });

    return stats;
  }
}

export default Logger;